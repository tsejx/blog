<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/blog/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/blog/css/main.css?v=6.3.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/favicon.ico?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon.ico?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon.ico?v=6.3.0">


  <link rel="mask-icon" href="/blog/images/favicon.ico?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/blog/',
    scheme: 'Mist',
    version: '6.3.0',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":true},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="需求背景最近在负责利用 Egret 白鹭游戏引擎开发一款课中互动游戏，其中一个功能需要将 HTML 字符串形式存库的题目内容应用在互动游戏中。但是白鹭引擎是通过 WebGL 进行渲染的，DOM 树中通过一个 &amp;lt;canvas&amp;gt; 标签承载，无法通过 innerHTML 的方式直接使用 HTML 字符串，当时花费了不少时间研究如何优雅地实现类似的需求。">
<meta name="keywords" content="前端开发">
<meta property="og:type" content="article">
<meta property="og:title" content="富文本题目字符串转 Base64 图片实现">
<meta property="og:url" content="https://tsejx.github.io/blog/rich-text-and-base64/index.html">
<meta property="og:site_name" content="mrsingsing">
<meta property="og:description" content="需求背景最近在负责利用 Egret 白鹭游戏引擎开发一款课中互动游戏，其中一个功能需要将 HTML 字符串形式存库的题目内容应用在互动游戏中。但是白鹭引擎是通过 WebGL 进行渲染的，DOM 树中通过一个 &amp;lt;canvas&amp;gt; 标签承载，无法通过 innerHTML 的方式直接使用 HTML 字符串，当时花费了不少时间研究如何优雅地实现类似的需求。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://img.mrsingsing.com/cq-img1.png">
<meta property="og:image" content="https://img.mrsingsing.com/cq-img2.png">
<meta property="og:image" content="https://img.mrsingsing.com/cq-img3.png">
<meta property="og:image" content="https://img.mrsingsing.com/cq-img4.png">
<meta property="og:image" content="https://img.mrsingsing.com/cq-img5.png">
<meta property="og:updated_time" content="2021-10-01T10:05:42.417Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="富文本题目字符串转 Base64 图片实现">
<meta name="twitter:description" content="需求背景最近在负责利用 Egret 白鹭游戏引擎开发一款课中互动游戏，其中一个功能需要将 HTML 字符串形式存库的题目内容应用在互动游戏中。但是白鹭引擎是通过 WebGL 进行渲染的，DOM 树中通过一个 &amp;lt;canvas&amp;gt; 标签承载，无法通过 innerHTML 的方式直接使用 HTML 字符串，当时花费了不少时间研究如何优雅地实现类似的需求。">
<meta name="twitter:image" content="https://img.mrsingsing.com/cq-img1.png">






  <link rel="canonical" href="https://tsejx.github.io/blog/rich-text-and-base64/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>富文本题目字符串转 Base64 图片实现 | mrsingsing</title>
  






  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f81f55e9e4db3ad1f98521812f24d5aa";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/blog/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">mrsingsing</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/blog/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/blog/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/blog/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://tsejx.github.io/blog/blog/rich-text-and-base64/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="tsejx">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/blog/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="mrsingsing">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">富文本题目字符串转 Base64 图片实现
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2021-03-13 00:00:00" itemprop="dateCreated datePublished" datetime="2021-03-13T00:00:00+00:00">2021-03-13</time>
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="需求背景"><a href="#需求背景" class="headerlink" title="需求背景"></a>需求背景</h2><p>最近在负责利用 Egret 白鹭游戏引擎开发一款课中互动游戏，其中一个功能需要将 HTML 字符串形式存库的题目内容应用在互动游戏中。但是白鹭引擎是通过 WebGL 进行渲染的，DOM 树中通过一个 <code>&lt;canvas&gt;</code> 标签承载，无法通过 <code>innerHTML</code> 的方式直接使用 HTML 字符串，当时花费了不少时间研究如何优雅地实现类似的需求。</p>
<a id="more"></a>
<h2 id="方案调研"><a href="#方案调研" class="headerlink" title="方案调研"></a>方案调研</h2><p>遇事先从文档查起，在白鹭文档和论坛中找到了 <code>egret.HtmlTextParser</code> 这个方法，这个方法能将 HTML 格式文本转换为可赋值 <code>egret.TextField#textFlow</code> 属性的对象。</p>
<p>原本以为事情就是这么简单，但是经过尝试后遇到以下的问题：</p>
<ol>
<li>题目内容中有引用外链的图片、SVG 等，该方法无法支持</li>
<li>题目 HTML 标签上含有 CSS 类名，这些需要应用固定样式的题目无法正常显示</li>
</ol>
<p>由于无法通过 Egret 提供的 API 实现我们想要的效果，只能另寻出路。思考了一会后，我想到了三种可供解决方案的方案：</p>
<ol>
<li>在 <code>&lt;canvas&gt;</code> 标签外的上层增大 <code>z-index</code> 覆盖一层题目的 HTML 代码</li>
<li>使用正则表达式匹配转换 HTML 字符串成对象数据结构，Egret 内部将对象数据转换为对应的 UI</li>
<li>渲染 HTML 富文本字符串，通过 <code>html2canvas</code> 等第三方库转换成图片，以图片的形式在 Egret 中使用</li>
</ol>
<p>第一种方案的缺陷比较明显：一是整个游戏由 Egret 引擎搭建，游戏的流程由项目内部代码实现控制，在外层挂载另外的 HTML 节点不好控制；二是题目显示学生答题后，有覆盖题目上层的正确答案（如下图所示），由于不同层级的缘故，无法实现题目内容再上层的覆盖，除非再单独建立一个图层覆盖，但这显示让整件事情变得更复杂、更难操作；三是这种方案在整个画布中不好定位。</p>
<p><img src="https://img.mrsingsing.com/cq-img1.png" alt="cq-img1"></p>
<p>第二种方案也存在难以解决的一些问题，虽然说目前集团内部已经有比较成熟的题库，但早期还是通过接入外部题库的方式扩充题库，题目录入的富文本编辑器也经过很长时间的迭代，事实上生成的 HTML 字符串也是各不相同，我们无法制定统一的正则表达式完美地匹配所有的情况。</p>
<p>这或许有点难以理解，在数学题目的题干中会存在公式，一些会以 SVG 的形式渲染，一些则粗暴地以图片的形式存在，以图片形式存在是无法通过已有条件判断其为公式，即便能判断其为公式，类似这种 SVG 形式的 XML 标签也无法在 Egret 中使用。</p>
<p>因此只剩下最后一种方案，也是我们最后我们采纳的一种方案，我们 AI 录播课在上课前有个缓冲阶段，需要给课室中的学生绑定答题器等操作，利用这段空档期，我们能在 Electron 客户端挂载一个原理视口的节点，通过 HTML 解析加载每道题目，并通过 <a href="https://github.com/niklasvh/html2canvas" target="_blank" rel="noopener">html2canvas</a> 转为 Base64 的图片后，再交由 Egret 处理。</p>
<h2 id="方案实现"><a href="#方案实现" class="headerlink" title="方案实现"></a>方案实现</h2><p>通过服务端接口获取到题目的数据列表后，我们将数据以 10 条为单位切割分组（由于渲染绘制截图的过程耗时，为了提高效率，采用渲染多条截图一次的方式实现），每次渲染 10 条数据在固定宽高的盒子内。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getBase64ByHtml2Canvas</span>(<span class="params">dataInfo</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    (<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 从以题目 ID 为键，题目数据为值的对象中抽离列表</span></span><br><span class="line">        <span class="keyword">const</span> dataList = <span class="built_in">Object</span>.values(dataInfo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断是否为有效的对象数组</span></span><br><span class="line">        <span class="keyword">if</span> (!isValidObjectArray(dataList)) &#123;</span><br><span class="line">          resolve(&#123;&#125;);</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> result = &#123;&#125;;</span><br><span class="line">        <span class="keyword">let</span> groups = [];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 为了提升效率，每次最多渲染 10 条题目，以最多 10 条为限制分好组别</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> x = <span class="number">0</span>; x &lt; <span class="built_in">Math</span>.ceil(dataList.length / <span class="number">10</span>); x++) &#123;</span><br><span class="line">          <span class="keyword">let</span> start = x * <span class="number">10</span>;</span><br><span class="line">          <span class="keyword">let</span> end = start + <span class="number">10</span>;</span><br><span class="line">          groups.push(dataList.slice(start, end));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> taskList <span class="keyword">of</span> groups) &#123;</span><br><span class="line">          <span class="keyword">const</span> taskResult = <span class="keyword">await</span> createHtml2CanvasPromise(taskList);</span><br><span class="line"></span><br><span class="line">          result = <span class="built_in">Object</span>.assign(&#123;&#125;, result, taskResult);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        resolve(result);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        reject(err);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createHtml2CanvasPromise</span>(<span class="params">dataList</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> root = <span class="built_in">document</span>.getElementById(<span class="string">'html2canvas'</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 渲染前将根节点清空</span></span><br><span class="line">      root.innerHTML = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> documentFragment = <span class="built_in">document</span>.createDocumentFragment();</span><br><span class="line"></span><br><span class="line">      dataList.forEach(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> div = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>);</span><br><span class="line">        div.classList.add(<span class="string">'container'</span>);</span><br><span class="line">        <span class="comment">// 题目内容</span></span><br><span class="line">        div.innerHTML = item.questionContentTranslate;</span><br><span class="line">        div.dataset.id = item.questionId;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 由于公式图片过小，所以特殊处理宽高放大两倍</span></span><br><span class="line">        <span class="keyword">const</span> tagNames: any = div.querySelectorAll(<span class="string">'.spark-formula-frame'</span>);</span><br><span class="line">        <span class="keyword">if</span> (tagNames.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          tagNames.forEach(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">            item.width = item.width * <span class="number">2</span>;</span><br><span class="line">            item.height = item.height * <span class="number">2</span>;</span><br><span class="line">            item.style.margin = <span class="string">'0 10px'</span>;</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        documentFragment.appendChild(div);</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      root.appendChild(documentFragment);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> images = <span class="built_in">Array</span>.from(root.getElementsByTagName(<span class="string">'img'</span>));</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> renderContent = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 解决图片还没加载完毕，就开始截图导致截取的图片为空白的问题</span></span><br><span class="line">        <span class="keyword">const</span> timer = setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          images = images.filter(<span class="function"><span class="params">item</span> =&gt;</span> item &amp;&amp; !item.complete);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (images.length === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> clientRect = root.getBoundingClientRect();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 开始通过 html2canvas 绘制并生成图片</span></span><br><span class="line">            html2canvasformula(root, &#123;</span><br><span class="line">              backgroundColor: <span class="literal">null</span>,</span><br><span class="line">              useCORS: <span class="literal">true</span>,</span><br><span class="line">              width: clientRect.width,</span><br><span class="line">              height: clientRect.height,</span><br><span class="line">            &#125;)</span><br><span class="line">              .then(<span class="function"><span class="params">canvas</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="comment">// 经过 html2canvas 处理，异步会返回 canvas 画布，后续操作需要自行处理</span></span><br><span class="line">                <span class="keyword">const</span> ctx = canvas.getContext(<span class="string">'2d'</span>);</span><br><span class="line"></span><br><span class="line">                <span class="built_in">document</span>.body.append(canvas);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">const</span> result = dataList.reduce(<span class="function">(<span class="params">acc, item, index</span>) =&gt;</span> &#123;</span><br><span class="line">                  <span class="keyword">const</span> elementRef = <span class="built_in">Array</span>.from(root.children)[index];</span><br><span class="line">                  <span class="keyword">const</span> clientRect = elementRef.getBoundingClientRect();</span><br><span class="line"></span><br><span class="line">                  <span class="comment">// 截取的图片（Base64）</span></span><br><span class="line">                  <span class="keyword">const</span> base64 = cutImg(ctx, index + <span class="number">1</span>, clientRect.width, clientRect.height);</span><br><span class="line"></span><br><span class="line">                  <span class="comment">// 这是最终返回的自定义结构</span></span><br><span class="line">                  <span class="keyword">const</span> payload: any = &#123;</span><br><span class="line">                    questionId: item.questionId,</span><br><span class="line">                    answer:</span><br><span class="line">                      item.questionExplains &amp;&amp; isValidObjectArray(item.questionExplains)</span><br><span class="line">                        ? item.questionExplains[<span class="number">0</span>].answerTranslate</span><br><span class="line">                        : <span class="literal">null</span>,</span><br><span class="line">                    audioUrl:</span><br><span class="line">                      item.audioList &amp;&amp; isValidObjectArray(item.audioList)</span><br><span class="line">                        ? item.audioList[<span class="number">0</span>].audioUrl</span><br><span class="line">                        : <span class="literal">null</span>,</span><br><span class="line">                    content: base64,</span><br><span class="line">                  &#125;;</span><br><span class="line"></span><br><span class="line">                  acc[item.questionId] = payload;</span><br><span class="line"></span><br><span class="line">                  <span class="keyword">return</span> acc;</span><br><span class="line">                &#125;, &#123;&#125;);</span><br><span class="line"></span><br><span class="line">                resolve(result);</span><br><span class="line">              &#125;)</span><br><span class="line">              .catch(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                resolve(&#123;&#125;);</span><br><span class="line">              &#125;);</span><br><span class="line"></span><br><span class="line">            clearTimeout(timer);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            renderContent();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;, <span class="number">250</span>);</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      renderContent();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      reject(err);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cutImg</span>(<span class="params">ctx, index, width, height</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 处理 Retina 高清屏</span></span><br><span class="line">  <span class="keyword">let</span> devicePixelRatio = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">window</span>.devicePixelRatio) &#123;</span><br><span class="line">    devicePixelRatio = <span class="built_in">window</span>.devicePixelRatio;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 盒子宽度：1008</span></span><br><span class="line">  <span class="comment">// 盒子高度：730</span></span><br><span class="line">  <span class="keyword">const</span> imgWidth = (width || <span class="number">1008</span>) * devicePixelRatio;</span><br><span class="line">  <span class="keyword">const</span> imgHeight = (height || <span class="number">730</span>) * devicePixelRatio;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> sw = index * imgWidth - imgWidth;</span><br><span class="line">  <span class="keyword">let</span> imageData = ctx.getImageData(sw, <span class="number">0</span>, imgWidth, imgHeight);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> canvas = <span class="built_in">document</span>.createElement(<span class="string">'canvas'</span>);</span><br><span class="line">  canvas.width = imgWidth;</span><br><span class="line">  canvas.height = imgHeight;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> context = canvas.getContext(<span class="string">'2d'</span>);</span><br><span class="line">  context.putImageData(imageData, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> canvas.toDataURL();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="源码改造"><a href="#源码改造" class="headerlink" title="源码改造"></a>源码改造</h2><p>其实 <code>html2canvas</code> 的实现原理很简单，就是读取已经渲染好的 DOM 树的结构和样式信息，然后基于这些信息在 Canvas 画布中绘制出来，最后通过 <code>canvas.toDataURL</code> 转换为 Base64。</p>
<p>但实际我们在使用时却遇到了不少麻烦，下图为当时（2021 年 2 月下旬）利用 html2canvas（v1.0.0-rc.7）写的 demo。如图中顶部第一个方框，是由 innerHTML 将后端给题目 HTML 字符串插入到 DOM 数中的，配合已知的样式，能呈现出我们最终需要的效果，这里我们可以特别留意的是，1980 其实是一张图片，实际上是黑色的字体，但由于互动游戏中为深色背景，我们的设计师要求使用白色的字体，不然最终呈现的效果，其实就是第二个方框所呈现出来的。</p>
<p>第二个方框其实是渲染完第一个方框后，通过 html2canvas 绘制到 canvas 上的效果，但是 html2canvas 此时并不支持利用 <code>filter: invert(1)</code> 对图片进行反相处理，所以呈现的效果并不如我们的预期，这里就需要我们对源代码进行魔改。</p>
<p>其次，第三个方框是通过 canvas 的 toDataURL 最终生成的 Base64 代码，从第一视觉来看，比正常的差不多大了两倍有多，这里直觉告诉我，也许与设备像素比有关系。</p>
<p><img src="https://img.mrsingsing.com/cq-img2.png" alt="cq-img2"></p>
<p><a href="https://github.com/niklasvh/html2canvas/blob/3982df1492bdc40a8e5fa16877cc0291883c8e1a/src/render/canvas/canvas-renderer.ts#L259" target="_blank" rel="noopener">https://github.com/niklasvh/html2canvas/blob/3982df1492bdc40a8e5fa16877cc0291883c8e1a/src/render/canvas/canvas-renderer.ts#L259</a></p>
<p>上述代码片段是 <code>html2canvas</code> 中，获取 HTML 然后绘制成 Canvas 的关键方法 <code>renderReplacedElement</code>，当执行 <code>ctx.restore()</code> 后表示此次绘制已经结束，但是这里我们添加一个方法，将对样式中存在 <code>filter</code> 属性的节点元素进行反相。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filterImage</span>(<span class="params">box: Bounds, filter: <span class="built_in">any</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> devicePixelRatio = <span class="built_in">window</span>.devicePixelRatio || <span class="number">1</span>;</span><br><span class="line">  <span class="comment">// Retina 高清屏适配</span></span><br><span class="line">  <span class="keyword">const</span> finalBox: <span class="built_in">any</span> = &#123;</span><br><span class="line">    left: devicePixelRatio * box.left,</span><br><span class="line">    top: devicePixelRatio * box.top,</span><br><span class="line">    width: devicePixelRatio * box.width,</span><br><span class="line">    height: devicePixelRatio * box.height,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="keyword">const</span> imageData: ImageData = <span class="keyword">this</span>.ctx.getImageData(</span><br><span class="line">    finalBox.left,</span><br><span class="line">    finalBox.top,</span><br><span class="line">    finalBox.width,</span><br><span class="line">    finalBox.height</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> imgWidth = imageData.width,</span><br><span class="line">    imgHeight = imageData.height;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; imgHeight; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; imgWidth; j++) &#123;</span><br><span class="line">      <span class="keyword">const</span> index = i * <span class="number">4</span> * imgWidth + j * <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> red = imageData.data[index];</span><br><span class="line">      <span class="keyword">let</span> green = imageData.data[index + <span class="number">1</span>];</span><br><span class="line">      <span class="keyword">let</span> blue = imageData.data[index + <span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">      imageData.data[index] = <span class="number">255</span> - <span class="number">2</span> * red + red;</span><br><span class="line">      imageData.data[index + <span class="number">1</span>] = <span class="number">255</span> - <span class="number">2</span> * green + green;</span><br><span class="line">      imageData.data[index + <span class="number">2</span>] = <span class="number">255</span> - <span class="number">2</span> * blue + blue;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.ctx.putImageData(imageData, fialBox.left, fialBox.top);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么如何对 Canvas 图像进行反相呢？我们可以通过 <code>ctx.getImageData</code> 获取指定坐标宽高的区域，返回值为一个用来描述图片属性的数据对象 ImageData 对象。</p>
<p>它有三个属性，分别是 <code>data</code>、<code>width</code> 和 <code>height</code>。后两个属性代表指定图片的宽高，而另外一个 <code>data</code> 属性，则是一个 Uint8ClampedArray（8 位无符号整形固定数组）类型化数组。<code>data</code> 中的像素数据是按照从上到下，从左到右排列的，每个像素需要占用 4 位数据，分别是 R、G、B、Alpha 透明通道，</p>
<p>反相亦即将某个颜色替换成它的补色，在 RGB 模式中，反相实则是利用 255 减去 RGB 的值，得到的即为反相的 RGB 值。</p>
<p>通过在源码增加支持 Canvas 反相和兼容 Retina 屏幕的代码，解决了字体图片和尺寸问题。</p>
<p><img src="https://img.mrsingsing.com/cq-img3.png" alt="cq-img3"></p>
<p>但是还有一个问题需要解决，那就是如何利用最小代价在原有项目中更改第三方库的源代码呢？</p>
<p>通过查阅资料可知利用 <a href="https://www.npmjs.com/package/patch-package" target="_blank" rel="noopener">patch-package</a> 能够为其他 npm 包构建补丁包，其实际原理是在工程目录下保存一份与线上版本的 npm 包的 git diff 文件。具体使用方法可以参考 <a href="https://zhuanlan.zhihu.com/p/310266801" target="_blank" rel="noopener">那些修改 node_modules 的骚操作</a>。</p>
<p>不过需要注意的是，文中提及的最优解 <code>patch-package</code> 其实也是有缺陷的，例如，如果 node_modules 中的 npm 包是 ES6 模块打包成 ES5 模块，或者是经过混淆打包的，那么可读性方面都没有源代码高，对于开发者修改起来会比较麻烦。</p>
<p>而 html2canvas 模块包正是打包后的 ES5 模块包，所以尽管修改内容不是特别多，我们还是 clone 到本地后修改后发布到内部的 npm 库中，其他业务线有相关的需求也能直接引用该模块解决，也利于后期的拓展。</p>
<p>其实到这里，整个技术方案的实现难点就已经解决，拿到题目内容的 Base64 图片后，就能够在 Egret 中 egret.BitmapData 位图生成图片。</p>
<p>除此之外，这里需要对图片进行适配，要保证图片能完整显示在题目内容容器内。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> QuestionContent <span class="keyword">extends</span> eui.Component <span class="keyword">implements</span> eui.UIComponent &#123;</span><br><span class="line">  <span class="keyword">private</span> initQuestionContent(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> img: HTMLImageElement = <span class="keyword">new</span> Image();</span><br><span class="line">    <span class="comment">// this.questionInfo.content 就是 Base64</span></span><br><span class="line">    img.src = <span class="keyword">this</span>.questionInfo.content;</span><br><span class="line">    <span class="comment">// 是否是音频题</span></span><br><span class="line">    <span class="keyword">const</span> isAudio = <span class="keyword">this</span>.questionInfo.audioUrl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 图片适配</span></span><br><span class="line">    img.onload = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> width = <span class="number">0</span>,</span><br><span class="line">        height = <span class="number">0</span>;</span><br><span class="line">      <span class="comment">// 承载题目图片容器的可用最大宽高</span></span><br><span class="line">      <span class="keyword">const</span> avaliableWidth = <span class="keyword">this</span>.contentGroup.width;</span><br><span class="line">      <span class="keyword">let</span> avaliableHeight = <span class="keyword">this</span>.contentGroup.height;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (isAudio) &#123;</span><br><span class="line">        avaliableHeight = avaliableHeight - <span class="number">130</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (img.width &gt; img.height) &#123;</span><br><span class="line">        height = img.height * (avaliableWidth / img.width);</span><br><span class="line">        width = avaliableWidth;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        width = img.width * (avaliableHeight / img.height);</span><br><span class="line">        height = avaliableHeight;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      img.width = width;</span><br><span class="line">      img.height = height;</span><br><span class="line">      img[<span class="string">'avaliable'</span>] = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> bitmapdata: egret.BitmapData = <span class="keyword">new</span> egret.BitmapData(img);</span><br><span class="line">      <span class="keyword">const</span> texture: egret.Texture = <span class="keyword">new</span> egret.Texture();</span><br><span class="line">      texture.disposeBitmapData = <span class="literal">true</span>;</span><br><span class="line">      texture.bitmapData = bitmapdata;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.contentBitmap = <span class="keyword">new</span> egret.Bitmap(texture);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 由于有音频组件，所以题目要向下移动 103 个单位高度</span></span><br><span class="line">      <span class="keyword">if</span> (isAudio) &#123;</span><br><span class="line">        <span class="keyword">this</span>.contentBitmap.y = <span class="number">103</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 将题目位图插入舞台</span></span><br><span class="line">      <span class="keyword">this</span>.contentGroup.addChild(<span class="keyword">this</span>.contentBitmap);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终呈现的效果如下图所示：</p>
<p><img src="https://img.mrsingsing.com/cq-img4.png" alt="cq-img4"></p>
<p><img src="https://img.mrsingsing.com/cq-img5.png" alt="cq-img5"></p>
<p>参考资料</p>
<ul>
<li><a href="https://segmentfault.com/a/1190000038551328" target="_blank" rel="noopener">html2canvas 实现浏览器截图的原理（包含源码分析的通用方法）</a></li>
<li><a href="https://segmentfault.com/a/1190000011478657" target="_blank" rel="noopener">基于 html2canvas 实现网页保存为图片及图片清晰度优化</a></li>
</ul>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/blog/about-content-delivery-network/" rel="next" title="关于 CDN 内容分发网络">
                <i class="fa fa-chevron-left"></i> 关于 CDN 内容分发网络
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/blog/web-video-editor-infra/" rel="prev" title="云视频剪辑配齐工具实践复盘（架构篇）">
                云视频剪辑配齐工具实践复盘（架构篇） <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/blog/images/avatar.jpeg" alt="tsejx">
            
              <p class="site-author-name" itemprop="name">tsejx</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/blog/archives/">
                
                    <span class="site-state-item-count">15</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              

              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/tsejx" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
            </div>
          

          
          
            <div class="cc-license motion-element" itemprop="license">
              <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank">
                <img src="/blog/images/cc-by-nc-sa.svg" alt="Creative Commons">
              </a>
            </div>
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#需求背景"><span class="nav-number">1.</span> <span class="nav-text">需求背景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#方案调研"><span class="nav-number">2.</span> <span class="nav-text">方案调研</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#方案实现"><span class="nav-number">3.</span> <span class="nav-text">方案实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#源码改造"><span class="nav-number">4.</span> <span class="nav-text">源码改造</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">tsejx</span>

  

  
</div>











        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/blog/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/blog/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/blog/js/src/motion.js?v=6.3.0"></script>



  
  

  
  <script type="text/javascript" src="/blog/js/src/scrollspy.js?v=6.3.0"></script>
<script type="text/javascript" src="/blog/js/src/post-details.js?v=6.3.0"></script>



  


  <script type="text/javascript" src="/blog/js/src/bootstrap.js?v=6.3.0"></script>



  



  










  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
